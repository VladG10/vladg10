<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CÃ¡psulas</title>

<style>
  :root{
    --panel: rgba(0,0,0,.35);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.65);
    --line: rgba(255,255,255,.12);
  }

  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(circle at 50% 20%, #9b0022 0%, #6d0015 60%, #4a000f 100%);
    color: var(--text);
    display:flex;
    justify-content:center;
  }

  .wrap{
    width:min(760px, 92vw);
    padding: 32px 0 80px;
  }

  .intro{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 22px 18px;
    margin-bottom: 14px;
    text-align:left;
    backdrop-filter: blur(2px);
  }
  .intro h1{
    margin:0 0 8px;
    font-size: 18px;
    letter-spacing:.2px;
  }
  .intro p{
    margin:0;
    color: var(--muted);
    line-height:1.5;
  }
  .meta{
    margin-top: 10px;
    font-size: 13px;
    color: rgba(255,255,255,.55);
  }

  .progressWrap{
    margin: 10px 0 20px;
  }
  .progressTop{
    font-size: 13px;
    color: rgba(255,255,255,.65);
    margin-bottom: 6px;
    letter-spacing: .5px;
  }
  .progressBar{
    height: 4px;
    width: 100%;
    background: rgba(255,255,255,.15);
    border-radius: 10px;
    overflow: hidden;
  }
  #progressFill{
    height: 100%;
    width: 0%;
    background: rgba(255,255,255,.85);
    transition: width .6s ease;
  }

  .card{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 26px 18px;
    margin: 14px 0;
    text-align:center;
    backdrop-filter: blur(2px);
  }

  /* NÃºmero mÃ¡s elegante */
  .num{
    font-size: 46px;
    letter-spacing: 2px;
    font-weight: 900;
    color: rgba(255,255,255,.18);
    text-shadow: 0 1px 0 rgba(0,0,0,.25);
    margin-bottom: 8px;
    user-select:none;
  }

  .text{
    font-size: 20px;
    line-height: 1.5;
    text-align: left;
    padding: 0 10px;
  }

  .gate{
    border-radius: 14px;
    padding: 18px 16px;
    margin: 12px 0 18px;
    border: 1px dashed rgba(255,255,255,.25);
    color: rgba(255,255,255,.78);
    text-align:left;
    transition: box-shadow .35s ease;
    background: rgba(0,0,0,.10);
    backdrop-filter: blur(2px);
  }
  .gate b{ color: rgba(255,255,255,.95); }

  .gateTop{ font-size: 15px; margin-bottom: 6px; }
  .gateMid{ color: rgba(255,255,255,.75); margin-bottom: 10px; }
  .gateBottom{ font-size: 13px; color: rgba(255,255,255,.62); }

  .ghost{
    margin-top: 12px;
    border-radius: 12px;
    padding: 9px 12px;
    border: 1px solid rgba(255,255,255,.28);
    background: rgba(0,0,0,.12);
    color: rgba(255,255,255,.88);
    cursor: pointer;
  }
  .ghost:active{ transform: translateY(1px); }

  .audio{
    margin-top: 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }

  .btn{
    border: 1px solid rgba(255,255,255,.35);
    background: rgba(255,255,255,.92);
    color: #3a0010;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 700;
    cursor:pointer;
  }
  .btn:active{ transform: translateY(1px); }

  .small{
    font-size: 13px;
    color: rgba(255,255,255,.65);
    text-align:center;
    line-height: 1.35;
  }

  /* AnimaciÃ³n solo cuando JS agrega la clase */
  .just-revealed{
    animation: pop .55s ease both;
  }
  @keyframes pop{
    from { opacity:0; transform: translateY(10px); }
    to   { opacity:1; transform: translateY(0); }
  }

  @media (max-width: 480px){
    .text{ font-size: 18px; }
    .num{ font-size: 38px; }
    .intro{ padding: 18px 14px; }
  }
</style>
</head>

<body>
  <div class="wrap">

    <div class="intro">
      <h1>Hoy no quiero que leas todo de golpe.</h1>
      <p>Quiero que lo vivas conmigo. Regresa cuando el candado te lo pida.</p>
      <div class="meta" id="tzMeta"></div>
    </div>

    <div class="progressWrap">
      <div class="progressTop">
        <span id="progressText">Capa 00 de 14</span>
      </div>
      <div class="progressBar">
        <div id="progressFill"></div>
      </div>
    </div>

    <div id="timeline"></div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const START_HOUR = 9;
  const START_MIN  = 14;
  const TOTAL = 14;

  // Edita tus capas aquÃ­
  const CAPAS = [
    "Cuando veo tu nombre en mi celular, algo en mÃ­ se calma y se entusiasma al mismo tiempo.",
    "Hay algo que me gana siempre: cuando me dices â€œpequeÃ±oâ€ con esa voz tierna.",
    "A veces te imagino en ese camino junto a la playa, entrando a la ciudad al atardecer. No sÃ© por quÃ©, pero ahÃ­ se siente todo posible.",
    "Me da tranquilidad que seas tan decisiva. Sabes lo que quieres. Yo a veces todavÃ­a estoy descubriÃ©ndoloâ€¦ y me gusta que me inspires a moverme.",
    "Y sÃ­â€¦ me encanta cuando te emocionas jugando algo y te pones competitiva. Me da ternura verte sobre-emocionarte por ganar.",
    "La distancia no me asusta por falta de amor. Me asusta no poder abrazarte cuando lo necesito.",
    "Cuando hablamos, me duele no saber expresarme bien. Y me pesa la idea de perderte por no decir las cosas como deberÃ­a.",
    "A veces me meto en mi cabeza mÃ¡s de lo necesario. Pero contigo quiero aprender a pensar menos y sentir mÃ¡s.",
    "No siempre soy el mejor novio. A veces me distraigo. A veces me pierdo en cosas pequeÃ±as. Pero no porque no me importes.",
    "TodavÃ­a estoy ordenando mi vida. Y quiero que, mientras lo hago, tÃº veas que sÃ­ estoy intentando ser mejor.",
    "Me cuesta mostrar mis partes menos ordenadas. Las dudas, la confusiÃ³n, el no tener todo claro. Pero contigo quiero aprender a hacerlo sin miedo.",
    "Pero incluso con eso, quiero quedarme. Porque me haces crecer. Porque contigo no me quedo igual.",
    "Quiero viajar contigo. Quiero que tengamos recuerdos que no quepan en una pantalla.",
    "No tengo todo resuelto. Pero contigo no quiero correr ni esconderme. Quiero estar. Quiero construir. Quiero aprender a hacerlo mejor cada dÃ­a. Y eso lo quiero contigo."
  ];

  // Audio final
  const AUDIO_FILE = "mensaje-final.mp3"; // sÃºbelo al repo con este nombre
  const AUDIO_LABEL = "â–¶ Escuchar mensaje final";

  // Microcopy gates (13 gates entre 14 capas)
  const GATE_LINES = [
    "No te me adelantes ðŸ˜Œ",
    "Esto tiene contexto, paciencia.",
    "Para ti.",
    "Ok, pausa dramÃ¡tica controlada.",
    "Prometo que no todo va a ser intenso.",
    "AquÃ­ es donde normalmente me trabo hablando.",
    "No me estoy poniendo filosÃ³fico. Buenoâ€¦ tal vez un poco.",
    "Si esto fuera en persona, aquÃ­ me rascarÃ­a la cabeza.",
    "Prometo que no es crisis existencial. Solo transparencia.",
    "Esta parte no la ensayÃ©.",
    "Okâ€¦ aquÃ­ viene algo importante.",
    "Ya casi. No cierres la pestaÃ±a.",
    "Ahora sÃ­. Sin chistes."
  ];

  // =========================
  // HELPERS
  // =========================
  const pad2 = n => String(n).padStart(2, "0");
  const now = () => new Date();

  function formatTime(d){
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function buildUnlockTimes(baseDate){
    const times = [];
    for(let i=0;i<TOTAL;i++){
      const d = new Date(baseDate);
      d.setHours(START_HOUR + i, START_MIN, 0, 0);
      times.push(d);
    }
    return times;
  }

  function msToCountdown(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    if(hh > 0) return `${hh}h ${mm}m`;
    if(mm > 0) return `${mm}m ${ss}s`;
    return `${ss}s`;
  }

  function gateCopy(nextIndex){
    // nextIndex: Ã­ndice 0-based de la capa que viene
    if(nextIndex <= 0) return GATE_LINES[0];
    return GATE_LINES[Math.min(GATE_LINES.length-1, nextIndex-1)] || "Regresa en un ratito.";
  }

  // Persistencia (para que NO reanime tras refresh)
  const SEEN_KEY = "caps_seen_layers_v1";
  function loadSeen(){
    try { return new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]")); }
    catch { return new Set(); }
  }
  function saveSeen(set){
    try { localStorage.setItem(SEEN_KEY, JSON.stringify([...set])); } catch {}
  }
  const seen = loadSeen();

  // =========================
  // DOM + BUILD ONCE
  // =========================
  const timeline = document.getElementById("timeline");
  const unlockTimes = buildUnlockTimes(now()); // â€œhoyâ€ en el dispositivo del usuario
  const layerEls = [];

  function build(){
    timeline.innerHTML = "";

    // Gate (uno solo) que se actualiza segÃºn la siguiente capa
    const gate = document.createElement("div");
    gate.className = "gate";
    gate.id = "mainGate";
    gate.innerHTML = `
      <div class="gateTop" id="gateTop"></div>
      <div class="gateMid" id="gateMid"></div>
      <div class="gateBottom" id="gateBottom"></div>
      <button class="ghost" id="refreshBtn" type="button">Actualizar</button>
    `;
    timeline.appendChild(gate);

    // 14 capas (creadas una sola vez, ocultas al inicio)
    for(let i=0;i<TOTAL;i++){
      const card = document.createElement("div");
      card.className = "card";
      card.style.display = "none";
      card.innerHTML = `
        <div class="num">${pad2(i+1)}</div>
        <div class="text">${CAPAS[i] ?? ""}</div>
      `;
      timeline.appendChild(card);
      layerEls.push({ card, index: i });
    }

    // Audio card (sale hasta el final)
    const audioCard = document.createElement("div");
    audioCard.className = "card";
    audioCard.id = "audioCard";
    audioCard.style.display = "none";
    audioCard.innerHTML = `
      <div class="audio">
        <button class="btn" id="playBtn" type="button">${AUDIO_LABEL}</button>
        <div class="small">Si no suena, revisa que exista <b>${AUDIO_FILE}</b> en el repo.</div>
        <audio id="finalAudio" preload="auto">
          <source src="${AUDIO_FILE}" type="audio/mpeg">
        </audio>
      </div>
    `;
    timeline.appendChild(audioCard);

    // hooks
    document.getElementById("refreshBtn").onclick = () => tick(true);

    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById("tzMeta").textContent = `Horario segÃºn este dispositivo (${tz}).`;

    document.getElementById("playBtn").onclick = async () => {
      const aud = document.getElementById("finalAudio");
      try { await aud.play(); }
      catch(e){ alert("Tu navegador bloqueÃ³ el audio. Toca de nuevo el botÃ³n."); }
    };
  }

  // =========================
  // TICK (updates only)
  // =========================
  function tick(force=false){
    const current = now();

    // cuÃ¡ntas capas ya estÃ¡n desbloqueadas
    let unlockedCount = 0;
    for(let i=0;i<unlockTimes.length;i++){
      if(current >= unlockTimes[i]) unlockedCount = i+1;
    }

    // Progreso visual
    const progressText = document.getElementById("progressText");
    const progressFill = document.getElementById("progressFill");
    progressText.textContent = `Capa ${pad2(unlockedCount)} de ${TOTAL}`;
    progressFill.style.width = `${(unlockedCount / TOTAL) * 100}%`;

    // Mostrar capas desbloqueadas sin recrearlas
    for(const item of layerEls){
      const { card, index } = item;
      const shouldBeVisible = index < unlockedCount;

      if(shouldBeVisible && card.style.display === "none"){
        card.style.display = "block";

        // Intensidad del nÃºmero segÃºn avance
        const intensity = 0.15 + (index / TOTAL) * 0.25;
        card.querySelector(".num").style.color = `rgba(255,255,255,${intensity})`;

        // Animar solo la primera vez
        if(!seen.has(index)){
          card.classList.add("just-revealed");
          setTimeout(() => card.classList.remove("just-revealed"), 650);
          seen.add(index);
          saveSeen(seen);
        }
      }
    }

    // Gate / Audio
    const gate = document.getElementById("mainGate");
    const audioCard = document.getElementById("audioCard");

    if(unlockedCount >= TOTAL){
      gate.style.display = "none";
      audioCard.style.display = "block";
      return;
    }

    gate.style.display = "block";
    audioCard.style.display = "none";

    const nextIndex = (unlockedCount === 0) ? 0 : unlockedCount;
    const nextTime = unlockTimes[nextIndex];
    const remaining = nextTime - current;

    document.getElementById("gateTop").innerHTML =
      (unlockedCount === 0)
        ? `ðŸ”’ <b>Primera capa a las ${formatTime(nextTime)}.</b>`
        : `ðŸ”’ <b>Siguiente capa a las ${formatTime(nextTime)}.</b>`;

    document.getElementById("gateMid").textContent = gateCopy(nextIndex);
    document.getElementById("gateBottom").innerHTML =
      `Faltan <b>${msToCountdown(remaining)}</b>`;

    // Gate late (Ãºltimos 30s)
    if(remaining < 30000 && remaining > 0){
      gate.style.boxShadow = "0 0 15px rgba(255,255,255,.15)";
    } else {
      gate.style.boxShadow = "none";
    }
  }

  // init
  build();
  tick(true);
  setInterval(() => tick(false), 1000);
</script>
</body>
</html>

