<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>C√°psulas</title>

<style>
  :root{
    --ruby:#7a0016;
    --panel: rgba(0,0,0,.35);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.65);
    --line: rgba(255,255,255,.12);
  }

  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--ruby);
    color: var(--text);
    display:flex;
    justify-content:center;
  }

  .wrap{
    width:min(760px, 92vw);
    padding: 32px 0 80px;
  }

  .intro{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 22px 18px;
    margin-bottom: 18px;
    text-align:left;
  }
  .intro h1{
    margin:0 0 8px;
    font-size: 18px;
    letter-spacing:.2px;
  }
  .intro p{
    margin:0;
    color: var(--muted);
    line-height:1.5;
  }

  .card{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 26px 18px;
    margin: 14px 0;
    text-align:center;
    backdrop-filter: blur(2px);
  }

  /*.num{
    font-size: 44px;
    letter-spacing: 2px;
    font-weight: 800;
    color: rgba(255,255,255,.22);
    margin-bottom: 8px;
    user-select:none;
  }*/

  .text{
    font-size: 20px;
    line-height: 1.45;
    padding: 0 6px;
  }

  .gate{
    border-radius: 14px;
    padding: 18px 16px;
    margin: 12px 0 18px;
    border: 1px dashed rgba(255,255,255,.25);
    color: rgba(255,255,255,.78);
    text-align:left;
  }
  .gate b{ color: rgba(255,255,255,.95); }

  .meta{
    margin-top: 10px;
    font-size: 13px;
    color: rgba(255,255,255,.55);
  }

  .audio{
    margin-top: 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }

  .btn{
    border: 1px solid rgba(255,255,255,.35);
    background: rgba(255,255,255,.92);
    color: #3a0010;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 700;
    cursor:pointer;
  }
  .btn:active{ transform: translateY(1px); }

  .small{
    font-size: 13px;
    color: rgba(255,255,255,.65);
  }

/* Animaci√≥n solo cuando JS pone .just-revealed */
.just-revealed{
  animation: pop .55s ease both;
}
@keyframes pop{
  from { opacity:0; transform: translateY(10px); }
  to   { opacity:1; transform: translateY(0); }
}

/* N√∫mero m√°s elegante: outline vibe */
.num{
  font-size: 46px;
  letter-spacing: 2px;
  font-weight: 900;
  color: rgba(255,255,255,.18);
  text-shadow: 0 1px 0 rgba(0,0,0,.25);
}

/* Gate layout m√°s ‚Äúdise√±ado‚Äù */
.gateTop{ font-size: 15px; margin-bottom: 6px; }
.gateMid{ color: rgba(255,255,255,.75); margin-bottom: 10px; }
.gateBottom{ font-size: 13px; color: rgba(255,255,255,.62); }

/* Bot√≥n ghost para actualizar */
.ghost{
  margin-top: 12px;
  border-radius: 12px;
  padding: 9px 12px;
  border: 1px solid rgba(255,255,255,.28);
  background: rgba(0,0,0,.12);
  color: rgba(255,255,255,.88);
  cursor: pointer;
}
.ghost:active{ transform: translateY(1px); 
}
</style>
</head>

<body>
  <div class="wrap">

    <div class="intro">
      <h1>Hoy no quiero que leas todo de golpe.</h1>
      <p>Quiero que lo vivas conmigo. Regresa cuando el candado te lo pida.</p>
      <div class="meta" id="tzMeta"></div>
    </div>

    <!-- Contenedor donde JS va a pintar capas + gates -->
    <div id="timeline"></div>

  </div>

<script>
  const START_HOUR = 21;
  const START_MIN  = 7;
  const TOTAL = 14;

  const CAPAS = [
    "Cuando pienso en ti, mi d√≠a se vuelve sol.",
    "Aqu√≠ va tu frase para la Capa 02.",
    "Aqu√≠ va tu frase para la Capa 03.",
    "Aqu√≠ va tu frase para la Capa 04.",
    "Aqu√≠ va tu frase para la Capa 05.",
    "Aqu√≠ va tu frase para la Capa 06.",
    "Aqu√≠ va tu frase para la Capa 07.",
    "Aqu√≠ va tu frase para la Capa 08.",
    "Aqu√≠ va tu frase para la Capa 09.",
    "Aqu√≠ va tu frase para la Capa 10.",
    "Aqu√≠ va tu frase para la Capa 11.",
    "Aqu√≠ va tu frase para la Capa 12.",
    "Aqu√≠ va tu frase para la Capa 13.",
    "Llegamos al final‚Ä¶ gracias por estar aqu√≠."
  ];

  const AUDIO_FILE = "mensaje-final.mp3";
  const AUDIO_LABEL = "‚ñ∂ Escuchar mensaje final";

  const GATE_LINES = [
    "No te me adelantes üòå",
    "Gu√°rdame tantito.",
    "Respira. Esto es con calma.",
    "Ok, pausa ceremonial.",
    "Vuelve cuando el reloj diga ‚Äòya‚Äô.",
    "Aqu√≠ la espera tambi√©n cuenta.",
    "No es castigo, es ritmo.",
    "Un ratito m√°s. Ya casi.",
    "Te juro que vale la pena.",
    "No corras, qu√©date conmigo.",
    "El siguiente pedacito viene en serio.",
    "Te tengo otra guardada.",
    "√öltima recta."
  ];

  const pad2 = n => String(n).padStart(2, "0");
  const now = () => new Date();

  function formatTime(d){ return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

  function buildUnlockTimes(baseDate){
    const times = [];
    for(let i=0;i<TOTAL;i++){
      const d = new Date(baseDate);
      d.setHours(START_HOUR, START_MIN + i, 0, 0);
      times.push(d);
    }
    return times;
  }

  function msToCountdown(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    if(hh > 0) return `${hh}h ${mm}m`;
    if(mm > 0) return `${mm}m ${ss}s`;
    return `${ss}s`;
  }

  function gateCopy(nextIndex){
    // nextIndex: √≠ndice 0-based de la capa que viene
    if(nextIndex <= 0) return GATE_LINES[0];
    return GATE_LINES[Math.min(GATE_LINES.length-1, nextIndex-1)] || "Regresa en un ratito.";
  }

  // ---- Persistencia para que NO re-anime tras refresh
  const SEEN_KEY = "caps_seen_layers_v1";
  function loadSeen(){
    try { return new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]")); }
    catch { return new Set(); }
  }
  function saveSeen(set){
    try { localStorage.setItem(SEEN_KEY, JSON.stringify([...set])); } catch {}
  }
  const seen = loadSeen(); // guarda √≠ndices ya ‚Äúvistos‚Äù

  // ---- DOM refs
  const timeline = document.getElementById("timeline");
  const unlockTimes = buildUnlockTimes(now()); // hoy seg√∫n el dispositivo
  const layerEls = []; // {card, index}

  // ---- Build UI ONCE
  function build(){
    timeline.innerHTML = "";

    // Si a√∫n no lleg√≥ la 1ra, solo gate (se actualiza con tick)
    const gate = document.createElement("div");
    gate.className = "gate";
    gate.id = "mainGate";
    gate.innerHTML = `
      <div class="gateTop" id="gateTop"></div>
      <div class="gateMid" id="gateMid"></div>
      <div class="gateBottom" id="gateBottom"></div>
      <button class="ghost" id="refreshBtn" type="button">Actualizar</button>
    `;
    timeline.appendChild(gate);

    // Crea las 14 capas pero ocultas (no las borramos nunca)
    for(let i=0;i<TOTAL;i++){
      const card = document.createElement("div");
      card.className = "card";
      card.style.display = "none"; // oculto hasta desbloqueo

      card.innerHTML = `
        <div class="num">${pad2(i+1)}</div>
        <div class="text">${CAPAS[i] ?? ""}</div>
      `;
      timeline.appendChild(card);
      layerEls.push({ card, index: i });
    }

    // Audio card (se muestra solo cuando llega a 14)
    const audioCard = document.createElement("div");
    audioCard.className = "card";
    audioCard.id = "audioCard";
    audioCard.style.display = "none";
    audioCard.innerHTML = `
      <div class="audio">
        <button class="btn" id="playBtn" type="button">${AUDIO_LABEL}</button>
        <div class="small">Si no suena, revisa que exista <b>${AUDIO_FILE}</b> en el repo.</div>
        <audio id="finalAudio" preload="auto">
          <source src="${AUDIO_FILE}" type="audio/mpeg">
        </audio>
      </div>
    `;
    timeline.appendChild(audioCard);

    // hooks
    document.getElementById("refreshBtn").onclick = () => tick(true);

    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById("tzMeta").textContent = `Horario seg√∫n este dispositivo (${tz}).`;

    // audio hook
    document.getElementById("playBtn").onclick = async () => {
      const aud = document.getElementById("finalAudio");
      try { await aud.play(); }
      catch(e){ alert("Tu navegador bloque√≥ el audio. Toca de nuevo el bot√≥n."); }
    };
  }

  // ---- Update loop (no repinta, solo actualiza)
  function tick(force = false){
    const current = now();

    // calcula cu√°ntas capas desbloqueadas
    let unlockedCount = 0;
    for(let i=0;i<unlockTimes.length;i++){
      if(current >= unlockTimes[i]) unlockedCount = i+1;
    }

    // mostrar capas desbloqueadas (sin reconstruir)
    for(let i=0;i<layerEls.length;i++){
      const { card, index } = layerEls[i];
      const shouldBeVisible = index < unlockedCount;

      if(shouldBeVisible && card.style.display === "none"){
        card.style.display = "block";

        // animar SOLO si es la primera vez que se revela (y no estaba guardado)
        if(!seen.has(index)){
          card.classList.add("just-revealed");
          // quita clase al terminar para que no vuelva a aplicar
          setTimeout(() => card.classList.remove("just-revealed"), 650);
          seen.add(index);
          saveSeen(seen);
        }
      }
    }

    // gate logic: si ya est√°n todas, ocultar gate y mostrar audio
    const gate = document.getElementById("mainGate");
    const audioCard = document.getElementById("audioCard");

    if(unlockedCount >= TOTAL){
      gate.style.display = "none";
      audioCard.style.display = "block";
      return;
    }

    // si a√∫n no hay ninguna capa, gate hacia la primera
    // si ya hay, gate hacia la siguiente
    let nextIndex = 0;
    if(unlockedCount === 0) nextIndex = 0;
    else nextIndex = unlockedCount;

    const nextTime = unlockTimes[nextIndex];
    gate.style.display = "block";

    document.getElementById("gateTop").innerHTML =
      (unlockedCount === 0)
        ? `üîí <b>Primera capa a las ${formatTime(nextTime)}.</b>`
        : `üîí <b>Siguiente capa a las ${formatTime(nextTime)}.</b>`;

    document.getElementById("gateMid").textContent = gateCopy(nextIndex);
    document.getElementById("gateBottom").innerHTML =
      `Faltan <b>${msToCountdown(nextTime - current)}</b>`;
  }

  build();
  tick(true);
  setInterval(() => tick(false), 1000);
</script>
</body>
</html>






